---
title: "Getting Started with mrgparamtab"
author: "Michael McDermott"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

Generating clear, well-formatted parameter tables for your NONMEM® model is an important part of reporting your model results, but it is often a tedious, time-consuming process. Here we show how to quickly and simply create parameter tables by leveraging a few intuitive functions designed to:

- Read in your model parameters from various NONMEM® output files
- Describe your model parameters in a YAML file
- Back-transform any parameters estimated in other domains (e.g., log- or logit-transformed variables)
- Calculate additional summary statistics (e.g., 95% confidence intervals, coefficient of variation (CV), etc.)

# Setup

```{r load packages, results = 'hide', message=FALSE, warning=FALSE}
library(mrgparamtab)
library(dplyr)
library(bbr)
```

`mrgparamtab` requires two inputs: a data.frame containing parameter estimates and a parameter key, ideally in yaml format. 

## Parameter key

The parameter key informs R how to interpret your model parameter values. `mrgparamtab` requires four arguments for each parameter type:

- `abb`: abbreviation for model parameter (we use latex coding)
- `desc`: parameter description to appear
- `panel`: the table panel the parameter should appear under
- `trans`: definition of how the parameter should be transformed

For example:

```{r, eval=FALSE}
THETA1:
  abb: "KA (1/h)"
  desc: "First order absorption rate constant"
  panel: struct
  trans: logTrans
```

We provide some built-in options for the `panel` and `trans` arguments, but you can expand these if needed.

We chose to describe all model parameters in a `pk-parameter-key.yaml` YAML file. The advantage is that, depending how your model development progressed, you can potentially use the same parameter key for the base model, final model and bootstrap model parameter tables.

### Panel

Note that there are a finite number of options included by default (see below) but you can include additional panels as needed.

- “struct” ~ Structural model parameters
- “cov” ~ Covariate effect parameters
- “IIV” (and a diagonal omega) ~ Interindividual variance parameters
- “IOV” (and a diagonal omega) ~ Interoccasion variance parameters
- Off-diagonal omegas have the panel name ~ Interindividual covariance parameters
panel == “RV” ~ Residual variance

# Format the parameters for the report

To generate a report-ready table we pass the parameter estimates and parameter key through a series of functions that:

- Join the parameter key information
- Perform some house-keeping based on the new parameter key information
- Calculate the 95% confidence interval
- Format the values for the report

```{r, include=FALSE}

estimates <- bbr::read_model(system.file("model/nonmem/102", package = "mrgparamtab")) %>%
             bbr::model_summary() %>%
             bbr::param_estimates()

paramKey <- system.file("model/nonmem/pk-parameter-key-new.yaml", package = "mrgparamtab")

```

Previously would run:

```{r, eval=FALSE}
param_df <- estimates
  mutate(name = gsub("[[:punct:]]", "", parameter_names)) %>% 
  inner_join(paramKey, by = "name")  %>%    
  checkTransforms() %>%       
  defineRows() %>%            
  getValueSE() %>%            
  get95CI() %>%               
  formatValues() %>%          
  formatGreekNames() %>%      
  getPanelName() %>%          
  dplyr::select(abb, greek, desc, value, ci, shrinkage, type) %>%
  as.data.frame()
```

With `mrgparamtab` would run:

```{r}
param_df <- 
  defineParamTable(.estimates = estimates, .key = paramKey, .ci = 95) %>% 
  formatParamTable()

param_df
```

## Functions used to format the parameters

Provided below is a quick description for each of the functions used above:

- `defineParamTable()` requires both the parameter estimates and parameter key as inputs. The information is combined from both, such that only the parameters found in the estimates data.frame will remain. It then checks whether parameters with special transformation rules were defined correctly. For example, for logit transformed variables, the code expects to see the trans (transform) column including the associated THETA value separated with a tilde symbol, e.g., logitOmSD ~ THETA3.
- `getValueSE()` determines a value (or estimate) for each model parameter and it's associated metric.
- `get95CI()` calculates the upper and lower values of the 95% confidence intervals (CIs).
- `formatParamTable()` formats the parameters ready for the final table. This potentially includes back transforming parameters and their CIs, rounding parameters using pmtables::sig, and combining columns. 

